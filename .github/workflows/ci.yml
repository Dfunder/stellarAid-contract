name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  CARGO_TERM_COLOR: always

jobs:
  # Rule 1: Check for errors (formatting, linting, compilation)
  check:
    name: Check - No Errors
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Check code formatting
        run: cargo fmt --all -- --check

      - name: Run clippy linter (treat warnings as errors)
        run: cargo clippy --all -- -D warnings

      - name: Check for compilation errors
        run: cargo check --all --locked

  # Rule 3: All tests must pass
  test:
    name: Test - All Tests Must Pass
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Run all tests
        run: cargo test --all --locked

      - name: Check for new test files
        id: check_new_tests
        if: github.event_name == 'pull_request'
        run: |
          echo "Checking for new test files in this PR..."
          git fetch origin ${{ github.base_ref }} --depth=1
          NEW_TEST_FILES=$(git diff --name-only origin/${{ github.base_ref }}...HEAD | grep -E '(test.*\.rs|.*_test\.rs|tests/.*\.rs)$' || true)
          if [ -n "$NEW_TEST_FILES" ]; then
            echo "New test files detected:"
            echo "$NEW_TEST_FILES"
            echo "new_tests=true" >> $GITHUB_OUTPUT
          else
            echo "No new test files detected"
            echo "new_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate new test files pass
        if: steps.check_new_tests.outputs.new_tests == 'true'
        run: |
          echo "✅ New test files detected and all tests passed!"

  # Rule 2: Build must succeed before PR
  build:
    name: Build - Must Build Successfully
    runs-on: ubuntu-latest
    needs: [check, test]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build native code
        run: cargo build --all --locked

      - name: Build WASM contract
        run: cargo build -p stellaraid-core --target wasm32-unknown-unknown --release

      - name: Upload WASM artifact
        uses: actions/upload-artifact@v4
        with:
          name: stellaraid-core-wasm
          path: target/wasm32-unknown-unknown/release/stellaraid_core.wasm
          retention-days: 30

  # PR Validation - Enforces all 3 rules
  pr-validation:
    name: PR Validation - All Rules Passed
    runs-on: ubuntu-latest
    needs: [check, test, build]
    if: always() && github.event_name == 'pull_request'
    steps:
      - name: Validate all checks passed
        run: |
          echo "========================================"
          echo "   PR Validation Summary"
          echo "========================================"
          echo ""
          echo "Rule 1 - No Errors: ${{ needs.check.result }}"
          echo "Rule 2 - Build Success: ${{ needs.build.result }}"
          echo "Rule 3 - Tests Pass: ${{ needs.test.result }}"
          echo ""
          
          if [ "${{ needs.check.result }}" == "success" ] && \
             [ "${{ needs.build.result }}" == "success" ] && \
             [ "${{ needs.test.result }}" == "success" ]; then
            echo "✅ ALL 3 RULES PASSED - PR APPROVED FOR MERGE"
            exit 0
          else
            echo "❌ ONE OR MORE RULES FAILED - PR CANNOT BE MERGED"
            echo ""
            echo "Please fix the following before merging:"
            [ "${{ needs.check.result }}" != "success" ] && echo "  - Fix compilation/formatting/linting errors (Rule 1)"
            [ "${{ needs.build.result }}" != "success" ] && echo "  - Ensure build succeeds (Rule 2)"
            [ "${{ needs.test.result }}" != "success" ] && echo "  - Fix failing tests (Rule 3)"
            exit 1
          fi

  # Cross-platform build verification
  build-matrix:
    name: Build Matrix (Cross-Platform)
    runs-on: ${{ matrix.os }}
    needs: check
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          targets: wasm32-unknown-unknown
          components: rustfmt, clippy

      - name: Cache Cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-

      - name: Build project
        run: cargo build --all --locked

      - name: Build WASM contract
        run: cargo build -p stellaraid-core --target wasm32-unknown-unknown

  # Security scans
  security:
    name: Security Scans
    runs-on: ubuntu-latest
    steps:
      - name: Checkout sources
        uses: actions/checkout@v4

      - name: cargo-audit scan
        uses: rustsec/audit-check@v2.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: cargo-deny check
        uses: embarkstudios/cargo-deny-action@v2
        with:
          command: check
